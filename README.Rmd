---
output: 
  rmarkdown::github_document:
    df_print: kable
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  dpi = 320,
  fig.retina = TRUE,
  fig.height = 5,
  fig.width = 7
)
options(
  max.print = 78,
  repos = "https://cloud.r-project.org"
  )
```

# dopingdata

<!-- badges: start -->

![](https://img.shields.io/badge/lifecycle-experimental-orange.svg)

<!-- https://img.shields.io/badge/lifecycle-stable-green.svg -->

<!-- badges: end -->

`dopingdata` contains data from the [United States Anti-Doping Agency](https://en.wikipedia.org/wiki/United_States_Anti-Doping_Agency) for exploration, modeling, and visualizations. The datasets in this package are derived from from the [USADA website](https://www.usada.org/) and the [World Anti-Doping Agency (WADA) banned substances list](https://www.wada-ama.org/en/prohibited-list?q=). Scraping, processing, and visualizing these data presented so many unique challenges I decided to combine the utilities into a package.

## Installation

You can install the development version of `dopingdata` like so:

``` r
# install.packages("devtools")
devtools::install_github("mjfrigaard/dopingdata")
```

```{r}
library(dopingdata)
```

## Scraping USADA Data

Each dataset was ha**rvest**ed using the [`rvest`](https://rvest.tidyverse.org/) and [`xml2`](https://xml2.r-lib.org/) packages, but using manners (with the [`polite`](https://dmi3kno.github.io/polite/) package).

```{r , eval=FALSE}
scrape_sanctions(dest_path = "data-raw/csv")
```

```         
Exporting data: data-raw/csv/2023-12-20/2023-12-20-usada_raw.csv
Data successfully exported!
```

`dopingdata` results in a lot of datasets, so I've written two helper functions (and an example raw dataset to demonstrate). 

```{r}
str(example_usada_raw)
```

### **export_data()**

`export_data()` will export data of various `type`s (`.csv`, `.tsv`, `.rds`, etc.) to a designated `path`:

```{r}
export_data(x = example_usada_raw, path = "dev", type = "rds")
```

```{r , echo=FALSE}
unlink(x = paste0("dev/", Sys.Date()), recursive = TRUE, force = TRUE)
```

### **export_extdata()**

`export_extdata()` is similiar, but exports the data to an `inst/` folder (helpful when writing R packages).

```{r}
export_extdata(x = example_usada_raw, path = "raw", type = "csv")
```


```{r , echo=FALSE}
unlink(x = paste0("inst/extdata/raw/", Sys.Date()), recursive = TRUE, force = TRUE)
```

### **process_text()** 

`process_text()` performs the following:

-   Processed data have all had the column names formatted `snake_case`

-   All of the text has been converted to lowercase

Below we'll import the scraped data in `data-raw/csv/` and process the text:

```{r echo=FALSE, message=FALSE, warning=FALSE}
usada_raw <- read.csv("data-raw/csv/2023-12-21/2023-12-21-usada_raw.csv")
usada <- process_text(raw_data = usada_raw)
str(usada)
```

## Dates

`sanction_announced` contains the date the sanction was announced, and about 30 of these contain two values (`original` and `updated`). Wrangling these values pose some challenges because they aren't *consistently* messy:

```{r}
subset(usada, 
  grepl("^original", usada[['sanction_announced']]), 
  c(athlete, sanction_announced))
```

### **clean_dates()**

I've written a `clean_dates()` function that takes `date_col`, `split` and `pattern` arguments: 

+ `df` = processed USADA dataset with messy dates

+ `date_col` = sanction date column (usually `sanction_announced`)

+ `split` = regex to pass to split argument of `strsplit()` (defaults to `"updated"`)

+ `pattern` = regex for other non-date pattern (defaults to `"original"`)

Below is an example dataset to demonstrate how `clean_dates()` works: 

```{r}
clean_dates(
  df = example_sanction_dates, 
  date_col = "ugly_dates", 
  split = "updated", 
  pattern = "original")
```

For `usada`, split the data into three `data.frame`s (`bad_dates`, `good_dates`, and `no_dates`).

```{r}
bad_dates <- subset(usada, 
  grepl("^original", usada[['sanction_announced']]))
good_dates <- subset(usada, 
  !grepl("^original", usada[['sanction_announced']]) & sanction_announced != "")
no_dates <- subset(usada,
  athlete == "*name removed" & sanction_announced == "")
```

Clean dates in `bad_dates` by splitting the bad dates on `"updated"` and provided `"original"` as the pattern (the opposite will also work). The `sanction_date` column will contain the correctly formatted updated `sanction_date`.

After formatting `good_dates` and removing `original_date` column we can combine the two with `rbind()`.

```{r}
cleaned_dates <- clean_dates(
  df = bad_dates, 
  date_col = "sanction_announced", 
  split = "updated", 
  pattern = "original")
# address names 
names(cleaned_dates)[names(cleaned_dates) == 'split_date'] <- 'sanction_date'
names(cleaned_dates)[names(cleaned_dates) == 'pattern_date'] <- 'original_date'
# format good_dates
good_dates$sanction_date <- as.Date(x = good_dates[['sanction_announced']], 
                                    format = "%m/%d/%Y")
# get intersecting names 
nms <- intersect(names(cleaned_dates), names(good_dates))
# bind the two datasets 
usada_dates <- rbind(good_dates, cleaned_dates[nms])
str(usada_dates)
```

Export the `usada_dates` to `data-raw/csv` folder.

```{r}
export_data(x = usada_dates, path = "data-raw/csv")
```

```{r REMOVE-DATE-DATA, echo=FALSE}
remove(list = c('bad_dates', 'cleaned_dates', 'good_dates', 'no_dates'))
```

## Sports 

To wrangle the sports, I'll use packages and functions from the `tidyverse` (`dplyr`, `stringr`, `tidyr`, etc.), but I also provide the base R alternatives (wherever possible).

```{r}
library(tidyverse)
```

`tidyverse` functions will return a `tibble` (not a `data.frame`), which prints fewer rows to the console. 

```{r}
usada_sports <- tibble::as_tibble(usada_dates)
str(usada_sports)
```

We can start by counting the `sport` column:

```{r count-sports-raw}
usada_sports |> 
  dplyr::count(sport, sort = TRUE)
```

### Support personnel

Some of the sports aren't sports--they're `athlete support personnel`. These need a  `support_personnel` identifier.

```{r support_personnel}
usada_sports <- dplyr::mutate(usada_sports, 
  # support_personnel
  support_personnel = 
    dplyr::if_else(condition = stringr::str_detect(
      sport, "support personnel"), 
      true = TRUE, false = FALSE, missing = NA)) 

usada_sports |> 
  dplyr::filter(stringr::str_detect(sport, "support personnel")) |> 
  dplyr::count(sport, support_personnel) |> 
  tidyr::pivot_wider(names_from = support_personnel, values_from = n)
```

### 'track and field' or 'track & field'

Convert sports like `track & field` to `track and field` to help determine which athletes/support personnel are involved in multiple sports.

```{r track-field}
usada_sports <- dplyr::mutate(usada_sports,
  # track & field
  sport = stringr::str_replace_all(sport, 'track and field', 'track & field'))

usada_sports |> 
  dplyr::filter(stringr::str_detect(sport, "track")) |> 
  dplyr::count(sport, support_personnel) |> 
  tidyr::pivot_wider(names_from = support_personnel, values_from = n)
```


### Spelling 

The incorrect spelling for `brazilian jiu-jitsu` (`brazillian jiu-jitsu`) is corrected below.

```{r bjj}
usada_sports <- dplyr::mutate(usada_sports, 
  # brazilian jiu-jitsu
  sport = dplyr::case_when(
    sport == 'brazillian jiu-jitsu' ~ 'brazilian jiu-jitsu',
    TRUE ~ sport)) 
usada_sports |> 
  dplyr::filter(stringr::str_detect(sport, "jitsu")) |> 
  dplyr::count(sport, sort = TRUE)
```


### 'paralympic'

An identifier for paralympic sports: `paralympic`. 

```{r paralympic}
usada_sports <- dplyr::mutate(usada_sports, 
  # paralympic
  paralympic = 
    dplyr::if_else(condition = stringr::str_detect(sport, "paralympic|para"), 
      true = TRUE, false = FALSE, missing = NA)) 

usada_sports |> 
  dplyr::filter(stringr::str_detect(sport, "paralympic|para")) |> 
  dplyr::count(paralympic, sport) |> 
  tidyr::pivot_wider(names_from = paralympic, values_from = n)
```

### Multiple sports

Identify the multiple sports using `and` and `, ` in a regular expression. 

```{r multiple_sports}
usada_sports <- dplyr::mutate(usada_sports, 
  # multiple_sports
  multiple_sports = 
    if_else(condition = stringr::str_detect(sport, "and |, "), 
      true = TRUE, false = FALSE, missing = NA))

usada_sports |> 
  dplyr::filter(stringr::str_detect(sport, "and |, ")) |> 
  dplyr::count(multiple_sports, sport) |> 
  tidyr::pivot_wider(names_from = multiple_sports, values_from = n)
```

### Tidy

Separate the multi-sport athletes in `usada_sports` as `multp_sport_athletes` and single-sport athletes in `single_sport_athletes`.

```{r create-multp_sport_athletes-single_sport_athletes, collapse=TRUE}
multp_sport_athletes <- usada_sports |> 
  dplyr::filter(multiple_sports == TRUE)
str(multp_sport_athletes)
single_sport_athletes <- usada_sports |> 
  dplyr::filter(multiple_sports == FALSE)
str(single_sport_athletes)
```


The athletes listed with multiple sports will occupy multiple rows in a 'tidy' version of `usada_sports`. 

  -   Passing the sport column to `tidyr::separate_rows()` and `stringr::str_trim()` in  `multp_sport_athletes` will create a `tidy_multp_sport_athletes` dataset:

```{r tidy_multp_sport_athletes}
tidy_multp_sport_athletes <- multp_sport_athletes |> 
  tidyr::separate_rows(sport, sep = "and|, ") |> 
  dplyr::mutate(sport = stringr::str_trim(sport, side = "both"))
str(tidy_multp_sport_athletes)
```

Finally, combine the two datasets.

```{r tidy_sports}
tidy_sports <- dplyr::bind_rows(single_sport_athletes, tidy_multp_sport_athletes)
str(tidy_sports)
```

### **clean_sports()**

These steps are combined in the `clean_sports()` function: 

```{r clean_sports-function, eval=TRUE}
str(
  clean_sports(
    df = usada_dates, 
    sport_col = "sport", 
    tidy = TRUE)
)
```

Verify there aren't any duplicates (again). 

```{r}
tidy_sports |> 
  dplyr::count(athlete, sanction_date, sport) |> 
  dplyr::filter(n > 1)
```

We can see the multi-sport athletes are listed in `tidy_sports` (but with one sport per row):

```{r check-tidy_sports}
tidy_sports |> 
    dplyr::filter(multiple_sports == TRUE) |> 
    dplyr::select(athlete, sport)
```


Export `tidy_sports` to `data-raw/`

```{r export-sports, eval=TRUE}
export_data(
  x = tidy_sports, 
  path = "data-raw/csv")
```

Verify 

```{r}
fs::dir_tree("data-raw/csv")
```

```{r REMOVE-SPORTS-DATA, echo=FALSE}
remove(list = ls()[grep(pattern = "mult|single", ls())])
```

## Substances 

We'll start by classifying 'adverse analytic findings' for a single banned substance. I've written a `get_recent_file()` function to quickly import .csv files from a specified directory:

### **get_recent_file()**

```{r}
pth <- paste0("data-raw/csv/", Sys.Date(), "/")
get_recent_file(pth, regex = 'sports', ext = '.csv')
```

This makes it easy to paste the necessary import code into the console (or R markdown file):

```r
tidy_sports <- read.delim(file = 'data-raw/csv/2023-12-21/2023-12-21-tidy_sports.csv', sep = ',')
```


#### AAFs vs ADRVs

The sanctions are divided into two categories: 

- `analytic`: [Adverse Analytical Finding](https://www.usada.org/spirit-of-sport/education/alphabet-soup-results-management/#:~:text), AAF; *An AAF is a report from a WADA-accredited laboratory that identifies the presence of a prohibited substance and/or its metabolites or markers in a sample.* 

- `non-analytic`: [Non-Analytical Anti-doping Rule Violation](https://www.usada.org/spirit-of-sport/education/non-analytical-anti-doping-rule-violations/) ADRV; *a non-analytical anti-doping rule violation does not stem from a positive urine or blood sample, but instead originates from, and is substantiated by, other evidence of doping or violations by an athlete or athlete support personnel.*. 

#### Substance/reason

The `substance_reason` column contains the details of the sanction, which can include the following information: 

1. The name of the banned substance  

2. A description of the infraction (if non-analytic)  

We will use regular expressions to identify the type of substance behind the sanction. See the examples below:

```{r steroid-view}
stringr::str_view(tidy_sports[['substance_reason']], 
  "use \\(epo & hgh\\)", match = TRUE)
```

```{r non-analytic-view}
stringr::str_view(tidy_sports[['substance_reason']],
  "tampering, complicity", match = TRUE)
```

Most of the non-analytic sanctions include the terms `non-analytic`/`non-analytical`/etc., as a prefix in the `substance_reason` column.

##### **`sanction_type`**

I can pass these terms as regular expressions to create the `sanction_type` variable, which will contain two values: `non-analytic` and `analytic`. I'll save this variable in a new the `usada_substances` dataset:

```{r usada_sanction_types, eval=TRUE}
usada_substances <- dplyr::mutate(.data = tidy_sports,
    sanction_type = dplyr::case_when(
      stringr::str_detect(string = substance_reason,
        "non-analytical") ~ "non-analytic",
      !stringr::str_detect(substance_reason,
        "non-analytical") ~ "analytic",
      TRUE ~ NA_character_
    )
  )
usada_substances |>
  dplyr::count(sanction_type, sort = TRUE)
```


Now I can filter `usada_substances` to the `analytical` sanctions in `sanction_type`.

*How can I identify the single vs. multiple substances?*

Let's take a look at four different sanctions in `example_sanction_type`:

```{r example_sanction_type, echo=FALSE}
dopingdata::example_sanction_type
```

##### **`substance_cat`**

We can see two analytic and two non-analytic sanctions, and each one has a single or multiple substance/reason. Fortunately, the sanctions with multiple items are separated by either semicolons (`; `), commas (`, `), or a conjunction (`and`), so I can use a regular expression to separate the items.

```{r test-substance_cat}
dplyr::mutate(example_sanction_type,
  substance_cat = case_when(
    # identify the multiple_sr substances using a regular expression
    stringr::str_detect(substance_reason, "; |, | and | & | / ") ~ 'multiple',
    # negate the regular expression for the single substances
    !stringr::str_detect(substance_reason, "; |, | and | & | / ") ~ 'single',
    TRUE ~ NA_character_)) |>
  dplyr::count(substance_cat, substance_reason) |> 
  tidyr::pivot_wider(names_from = substance_cat, values_from = n)
```

The `substance_cat` identifier can be used to separate sanctions with multiple substance/reasons from sanctions with a single substance or reason.

```{r}
usada_substances <- usada_substances |>
  dplyr::mutate(substance_cat = dplyr::case_when(
    stringr::str_detect(substance_reason, "; |, | and | & | / ") ~ 'multiple',
    !stringr::str_detect(substance_reason, "; |, | and | & | / ") ~ 'single',
    TRUE ~ NA_character_))
usada_substances |> 
  dplyr::count(substance_cat, sort = TRUE)
```

### Single analytic substances

First create a dataset that contains the sanctions with a single substance listed. 

```{r single_analytic_substances}
single_analytic_substances <- usada_substances |>
  dplyr::filter(substance_cat == 'single' & sanction_type == "analytic")
```

View the top ten single analytic substances:

```{r}
single_analytic_substances |> 
  count(substance_reason, sort = TRUE) |> 
  head(10)
```

### Multiple analytic substances

Next create a dataset with the sanctions listing multiple substances in `substance_reason`. Store these in `multiple_analytic_substances`.

```{r multiple_analytic_substances}
multiple_analytic_substances <- usada_substances |>
  dplyr::filter(substance_cat == 'multiple' & sanction_type == "analytic")
```

View the top ten multiple analytic substances:

```{r}
multiple_analytic_substances |> 
  count(substance_reason, sort = TRUE) |> 
  head(10)
```

#### Tidy substances 

Tidying the sanctions with multiple [WADA banned substances](https://www.wada-ama.org/en/prohibited-list?q) (i.e., one substance per athlete per row) will result in certain athletes appearing in the dataset more than once. The regular expressions below cover a range of semicolons, tabs, and spaces to identify and separate each substance. 

#### **add_match_col()**

I've written the `add_match_col()` function, which creates a new `'matched'` column with the matched regular expression pattern (it's like `str_view()`, but in a `data.frame`/`tibble`). I used `add_match_col()` while determining the correct pattern to match on (i.e., any substances listing `metabolites`):

```{r}
dplyr::mutate(multiple_analytic_substances,
  # add matched column
  matched = add_match_col(
    string = substance_reason, 
    pattern = "and its metabolite|and its metabolites|its metabolite")) |> 
  dplyr::select(substance_reason, dplyr::last_col()) |> 
  dplyr::filter(!is.na(matched))
```

The rows above are all matching correctly on the regular expression pattern. 

Below is a regular expression to differentiate the multiple substances on a sample from `multiple_analytic_substances`. This pattern will be passed to `tidyr::separate_rows()` (similar to multiple-sport athletes above).

```{r}
dplyr::sample_n(multiple_analytic_substances, size = 10, replace = FALSE) |> 
  dplyr::mutate(
    # replace plurals
      substance_reason = stringr::str_replace_all(substance_reason,
        "and its metabolite|and its metabolites|its metabolite",
        "(metabolite)")) |> 
    tidyr::separate_rows(substance_reason, 
        sep = "; |;\t|\\t|, |;| and |and a |and | & | / ") |> 
    dplyr::select(athlete, substance_reason)
```

The final step trims the white space from the tidy `substance_reason` column. The output will be stored in `tidy_multiple_substances`.

```{r tidy_multiple_substances}
tidy_multiple_substances <- dplyr::mutate(multiple_analytic_substances,
  # replace plurals
    substance_reason = stringr::str_replace_all(substance_reason,
      "and its metabolite|and its metabolites|its metabolite",
      "(metabolite)")) |> 
  tidyr::separate_rows(substance_reason, 
      sep = "; |;\t|\\t|, |;| and |and a |and | & | / ") |> 
  dplyr::mutate(substance_reason = trimws(substance_reason, "both"))
```

Now that we have both single and multiple substances in tidy formats, we can bind them together into a single `tidy_substances` dataset.

```{r tidy_substances}
tidy_substances <- rbind(single_analytic_substances, tidy_multiple_substances) 
```

The top 10 substances are below: 

```{r}
tidy_substances |> 
  dplyr::count(substance_reason, sort = TRUE) |> 
  head(10)
```

```{r, include=FALSE, eval=FALSE}
dplyr::mutate(multiple_analytic_substances,
  # replace plurals
    substance_reason = stringr::str_replace_all(substance_reason,
      "and its metabolite|and its metabolites|its metabolite",
      "(metabolite)")) |> 
  tidyr::separate_rows(substance_reason, 
      sep = "; |;\t|\\t|, |;| and |and a |and | & | / ") |> 
  dplyr::mutate(substance_reason = trimws(substance_reason, "both")) |> 
  dplyr::select(substance_reason) |> 
  purrr::as_vector() |> 
  writeLines()
```

### Classifying substances 

To identify the [WADA banned substances](https://www.wada-ama.org/en/prohibited-list#search-anchor), I've written `classify_wada_substances()`, a function that scans the `substance_reason` column and identifies any substances found on the [WADA list](https://www.wada-ama.org/sites/default/files/2022-09/2023list_en_final_9_september_2022.pdf). See the `classify_wada_substances()` documentation for more information.

#### **classify_wada_substances()**

`classify_wada_substances()` creates a `substance_group` variable with each of the WADA classifications (stored in `dopingdata::wada_classes`):

```{r show-dopingdata-wada_classes}
dopingdata::wada_classes
```


`dopingdata` stores vectors with each substance group in the WADA list (the `S1 ANABOLIC AGENTS` substances are below):

```{r s1_substances}
head(dopingdata::s1_substances, 10)
```

The substance group vectors are also stored as regular expressions (`s1_regex`), which we can use to match the `substance_reason` column on (see the example using `dopingdata::example_tidy_substances` dataset):

```{r veiw-s1}
stringr::str_view(string = example_tidy_substances$substance_reason,
  pattern = s1_regex, match = TRUE)
```

The output from `classify_wada_substances()` can be used to answer questions like: *what `substance_group`'s appear the most?*

```{r demo_classify_wada_substances}
tidy_substances <- classify_wada_substances(
  usada_data = tidy_substances,
  subs_column = "substance_reason") 
```


```{r REMOVE-SUBSTANCE-DATA, echo=FALSE}
remove(list = ls()[grep(pattern = "mult|single", ls())])
```


### `UNCLASSIFIED` single substances 

The following `single` substances are marked as `UNCLASSIFIED`:

```{r}
tidy_substances |>
  dplyr::filter(
      substance_cat == "single" & 
      substance_group == "UNCLASSIFIED" & 
      substance_reason != "") |>
  dplyr::distinct(athlete, substance_reason)
```



```{r reclass_substance-single, include=FALSE, echo=FALSE, eval=FALSE}
# 3α-hydroxy-5α-androst-1-en-17-one ----
# https://ufc.usada.org/ovince-saint-preux-accepts-second-doping-sanction/
# https://www.wada-ama.org/en/prohibited-list?page=0&q=Androstenedione&all=1#search-anchor
tidy_substances <- reclass_substance(
  df = tidy_substances,
  substance = "3α-hydroxy-5α-androst-1-en-17-one",
  value = "S1 ANABOLIC AGENTS")
# bpc-157 ----
# https://www.usada.org/spirit-of-sport/education/bpc-157-peptide-prohibited/
tidy_substances <- reclass_substance(
  df = tidy_substances,
  substance = "bpc-157",
  value = "S0 UNAPPROVED SUBSTANCES")
# methenolone ----
# 'Methenolone is a non-Specified Substance in the class of Anabolic Agents'
# https://ufc.usada.org/hamdy-abdelwahab-accepts-doping-sanction/
tidy_substances <- reclass_substance(
  df = tidy_substances,
  substance = "methenolone",
  value = "S1 ANABOLIC AGENTS")
# elevated t/e ----
# If an athlete’s testosterone/epitestosterone (T/E) ratio is greater than the 
# 6:1 limit, a further study be conducted to determine whether the individual 
# has a naturally elevated T/E ratio
tidy_substances <- reclass_substance(
  df = tidy_substances,
  substance = "elevated t/e",
  value = "S1 ANABOLIC AGENTS")
```

The final unclassified substance is actually a result from a miss-classified sanction type (for `rodriguez, yair`). 

```{r}
tidy_substances |>
  dplyr::filter(athlete == "rodriguez, yair") |>
  dplyr::select(athlete, substance_reason, substance_group, sanction_type)
```

For this particular athlete, the `sanction_type` should be `non-analytic`, and the `substance_group` should be missing (`NA_character_`)

```{r}
tidy_substances <- tidy_substances |>
  dplyr::mutate(sanction_type = case_when(
    athlete == "rodriguez, yair" ~ "non-analytic",
    TRUE ~ sanction_type
  )) |> 
  dplyr::mutate(substance_group = case_when(
    athlete == "rodriguez, yair" ~ NA_character_,
    TRUE ~ substance_group
  )) 
tidy_substances |>
  dplyr::filter(athlete == "rodriguez, yair") |>
  dplyr::select(athlete, substance_reason, substance_group, sanction_type)
```


### `UNCLASSIFIED` multiple substances 

```{r}
tidy_substances |>
  dplyr::filter(
      substance_cat == "multiple" & 
      substance_group == "UNCLASSIFIED" & 
      substance_reason != "") |>
  dplyr::distinct(substance_reason)
```

### Re-classifying substances

The substances that were not classified using the standard WADA list can be added with `reclass_substance()`

#### **reclass_substance()**

`reclass_substance()` takes a `df`, `substance`, and `value` (these substances can also added to their relative vector and regular expression in `data-raw/`).

```{r , eval=FALSE, echo=FALSE}
tidy_substances |>
  dplyr::filter(
      substance_cat == "multiple" & 
      substance_group == "UNCLASSIFIED" & 
      substance_reason != "") |>
  dplyr::distinct(substance_reason) |> 
  purrr::as_vector() |> 
  writeLines()
```

```{r}
# arimistane ----
tidy_substances <- reclass_substance(
  df = tidy_substances,
  substance = "arimistane",
  value = "S4 HORMONE AND METABOLIC MODULATORS")
# torasemide ----
tidy_substances <- reclass_substance(
  df = tidy_substances,
  substance = "torasemide",
  value = "S5 DIURETICS/MASKING AGENTS")
# igf-1 ----
tidy_substances <- reclass_substance(
  df = tidy_substances,
  substance = "igf-1",
  value = "S2 PEP HORMONES/G FACTORS/MIMETICS")
# human chorionic gonadotropin (hcg)  ----
# https://www.usada.org/athletes/antidoping101/athlete-guide-anti-doping/
# https://www.usada.org/spirit-of-sport/education/wellness-and-anti-aging-clinics/
tidy_substances <- reclass_substance(
  df = tidy_substances,
  substance = "^human chorionic gonadotropin \\(hcg\\)$",
  value = "S2 PEP HORMONES/G FACTORS/MIMETICS")
# intact human chorionic gonadtrophin (hcg)  ----
tidy_substances <- reclass_substance(
  df = tidy_substances,
  substance = "^intact human chorionic gonadtrophin \\(hcg\\)$",
  value = "S2 PEP HORMONES/G FACTORS/MIMETICS")
# aod-9064  ----
tidy_substances <- reclass_substance(
  df = tidy_substances,
  substance = "aod-9064",
  value = "S2 PEP HORMONES/G FACTORS/MIMETICS")
# s-23  ----
tidy_substances <- reclass_substance(
  df = tidy_substances,
  substance = "s-23",
  value = "S1 ANABOLIC AGENTS")
# methenolone  ----
tidy_substances <- reclass_substance(
  df = tidy_substances,
  substance = "methenolone",
  value = "S1 ANABOLIC AGENTS")
# thiazide metabolite 4-amino-6-chloro-1,3-benzenedisulfonamide (acb)  ----
tidy_substances <- reclass_substance(
  df = tidy_substances,
  substance = "^thiazide metabolite 4-amino-6-chloro-1,3-benzenedisulfonamide \\(acb\\)$",
  value = "S5 DIURETICS/MASKING AGENTS")
# methylecgonine  ----
# https://www.usada.org/sanction/mike-alexandrov-accepts-doping-sanction/
tidy_substances <- reclass_substance(
  df = tidy_substances,
  substance = "methylecgonine",
  value = "S6 STIMULANTS")
# propylhexadrine  ----
tidy_substances <- reclass_substance(
  df = tidy_substances,
  substance = "propylhexadrine",
  value = "S6 STIMULANTS")
# androst-(2,3)-en-17-one  ----
# this needs an anchor 
tidy_substances <- reclass_substance(
  df = tidy_substances,
  substance = "androst-\\(2,3\\)-en-17-one",
  value = "S1 ANABOLIC AGENTS")
# promagnon  ----
tidy_substances <- reclass_substance(
  df = tidy_substances,
  substance = "promagnon",
  value = "S1 ANABOLIC AGENTS")
# human chorionic gonadotrophin (hcg)  ----
tidy_substances <- reclass_substance(
  df = tidy_substances,
  substance = "human chorionic gonadotrophin \\(hcg\\)",
  value = "S2 PEP HORMONES/G FACTORS/MIMETICS")
```

After reclassifying the substances above, we can review the remaining `UNCLASSIFIED`/`multiple` sanctions:

```{r}
tidy_substances |>
  dplyr::filter(
      substance_cat == "multiple" & 
      substance_group == "UNCLASSIFIED" & 
      substance_reason != "") |>
  dplyr::distinct(substance_reason) 
```

These remaining `UNCLASSIFIED` substances should be marked as non-analytic sanctions in `sanction_type`:

```{r}
tidy_substances <- tidy_substances |> 
  mutate(
    sanction_type = dplyr::case_when(
      substance_group == "UNCLASSIFIED" & substance_reason == "possession" ~ "non-analytic",
      substance_group == "UNCLASSIFIED" & substance_reason == "use/attempted use" ~ "non-analytic",
      substance_group == "UNCLASSIFIED" & substance_reason == "evading sample collection" ~ "non-analytic",
      substance_group == "UNCLASSIFIED" & substance_reason == "non-anatlyical: administration" ~ "non-analytic",
      substance_group == "UNCLASSIFIED" & substance_reason == "trafficking" ~ "non-analytic",
      TRUE ~ sanction_type
    )
  ) 
```

And non-analytic sanctions should have missing (`NA_character_`) values for `substance_group`:

```{r}
tidy_substances <- tidy_substances |> 
  dplyr::mutate(
    substance_group = dplyr::case_when(
      sanction_type == "non-analytic" ~ NA_character_,
      TRUE ~ substance_group)
    ) 
```

And we can remove the missing `substance_reason` values 

```{r}
tidy_substances <- dplyr::filter(tidy_substances, substance_reason != "")
```

Now all the substances have been properly classified as [Adverse Analytical Findings](https://www.usada.org/spirit-of-sport/education/alphabet-soup-results-management/#:~:text).

```{r}
tidy_substances |> 
  dplyr::count(sanction_type, substance_group) |> 
  tidyr::pivot_wider(names_from = sanction_type, values_from = n)
```

And the `non-analytic` sanctions are truly [Non-Analytical Anti-doping Rule Violations](https://www.usada.org/spirit-of-sport/education/non-analytical-anti-doping-rule-violations/).

```{r}
dplyr::filter(tidy_substances, sanction_type == "non-analytic") |> 
  dplyr::count(substance_reason, substance_cat) |> 
  tidyr::pivot_wider(names_from = substance_cat, values_from = n)
```


Export `tidy_substances` to `data-raw/`

```{r export-tidy_substances, eval=TRUE}
export_data(
  x = tidy_substances, 
  path = "data-raw/csv")
```

Verify 

```{r}
fs::dir_tree("data-raw/csv")
```

## Visualize

```{r}
library(ggplot2)
library(extrafont)
loadfonts(quiet = TRUE)
library(tvthemes)
library(ggwaffle)
```

### Adverse Analytical Findings

```{r}
tidy_substances |>
  dplyr::filter(!is.na(substance_group)) |>
  dplyr::mutate(substance_group = factor(substance_group)) |>
  dplyr::count(substance_group, name = "count") |>
  ggplot2::ggplot(ggplot2::aes(
    x = count,
    y = forcats::fct_reorder(substance_group, count)
  )) +
  ggplot2::geom_col() + 
  ggplot2::labs(
    title = "Total Adverse Analytical Findings",
    subtitle = "What is the most common banned substance?",
    y = "WADA Classification", x = "Counts"
  )
```

### Sports 

```{r}
tidy_substances |>
  dplyr::filter(!is.na(sport)) |>
  dplyr::count(sport, name = "count", sort = TRUE) |>
  head(10) |> 
  ggplot2::ggplot(ggplot2::aes(
    x = count,
    y = forcats::fct_reorder(as.factor(sport), count)
  )) +
  ggplot2::geom_col() + 
  ggplot2::labs(
    title = "Top Ten Sports with Sanctions",
    subtitle = "What sports have the most adverse analytical findings?",
    y = "Sport", x = "Number of Sanctions"
  )
```


### Top Adverse Analytical Findings & Sports 

```{r}
top3_sports <- tidy_substances |>
  dplyr::filter(!is.na(sport)) |>
  dplyr::count(sport, name = "count", sort = TRUE) |>
  head(3) |> 
  dplyr::select(sport) |> 
  purrr::as_vector() |> 
  base::unname()
tidy_substances |> 
  filter(sport %in% top3_sports & 
      substance_group %in% 
      c("S1 ANABOLIC AGENTS", 
        "S6 STIMULANTS", 
        "S4 HORMONE AND METABOLIC MODULATORS", 
        "S5 DIURETICS/MASKING AGENTS", 
        "S2 PEP HORMONES/G FACTORS/MIMETICS", 
        "S8 CANNABINOIDS", 
        "S3 BETA-2 AGONISTS"
)) |> 
  dplyr::mutate(substance_group = factor(substance_group)) |>
  dplyr::count(substance_group, sport, name = "count") |>
  ggplot2::ggplot(ggplot2::aes(
    x = count,
    y = forcats::fct_reorder(substance_group, count), 
    group = sport
  )) +
  ggplot2::geom_col(aes(fill = substance_group), width = 0.45) + 
  ggplot2::facet_wrap(~ sport, scales = 'free_x', nrow = 1) +
  ggplot2::labs(
    title = "Top Adverse Analytical Findings",
    subtitle = "Most Common Substances by Sport",
    y = "WADA Classification", 
    x = "Total Sanctions"
  ) + 
  tvthemes::scale_fill_bigHero6(reverse = TRUE) +
  ggplot2::theme_minimal() +
  ggplot2::theme(legend.position = 'none')
```



```{r , eval=FALSE, echo=FALSE}
tidy_substances |> 
  filter(substance_group == "S6 STIMULANTS" & 
         sport %in% top3_sports) |> 
  dplyr::count(substance_reason, sport, name = "count") |>
  ggplot2::ggplot(ggplot2::aes(
    x = count,
    y = forcats::fct_reorder(as.factor(substance_reason), count), 
    group = sport
  )) +
  ggplot2::geom_col(aes(fill = substance_reason), width = 0.75) + 
  ggplot2::facet_wrap(~ sport, scales = 'free_x', nrow = 1) +
  ggplot2::labs(
    title = "S6 STIMULANTS",
    subtitle = "Stimulants between sports",
    y = "WADA Classification", 
    x = "Total Sanctions"
  ) + 
  ggplot2::theme_minimal() + 
  ggplot2::theme(legend.position = 'none')
```

```{r , eval=FALSE, echo=FALSE}
top3_classes <- tidy_substances |>
  dplyr::filter(!is.na(substance_group)) |>
  dplyr::count(substance_group, name = "count", sort = TRUE) |>
  head(3) |> 
  dplyr::select(substance_group) |> 
  purrr::as_vector() |> 
  base::unname()
heatmap_substances <- tidy_substances |> 
  filter(substance_group == "S6 STIMULANTS" & sport %in% top3_sports) |> 
  dplyr::mutate(substance_group = factor(substance_group)) |> 
  group_by(sport, substance_reason) |>
  summarise(occurrence = n()) |>
  ungroup()
```

```{r , eval=FALSE, echo=FALSE}
ggplot2::ggplot(data = heatmap_substances, 
       aes(y = substance_reason,
           x = sport, 
           fill = occurrence)) + 
       geom_tile() + 
  theme(legend.position = "bottom") + 
  ggplot2::labs(
  title = "Sanctions by Sport", 
  y = "Sport", 
  x = "WADA group", 
  fill = "Occurrences")
```

### MMA Substances 

```{r}
waffle_mma <- tidy_substances |> 
  dplyr::filter(sport == "mixed martial arts") |>     
  ggwaffle::waffle_iron(aes_d(group = substance_group))

ggplot2::ggplot(data = waffle_mma, 
       ggplot2::aes(x = x, 
           y = y, 
           fill = group)) + 
  ggwaffle::geom_waffle() +
  ggplot2::theme(legend.position = "right") +
  ggwaffle::theme_waffle() + 
  labs(title = "Mixed martial arts",
    subtitle = "Most common WADA banned substances",
    x = "", y = "")
```

```{r , eval=FALSE, echo=FALSE}
library(patchwork)
waffle_weightlifting <- tidy_substances |> 
  dplyr::filter(sport == "weightlifting") |>     
  ggwaffle::waffle_iron(aes_d(group = substance_group))

waffle_cycling <- tidy_substances |> 
  dplyr::filter(sport == "cycling") |>     
  ggwaffle::waffle_iron(aes_d(group = substance_group))

ggp_weightlifting_waffle <- ggplot2::ggplot(data = waffle_weightlifting, 
       ggplot2::aes(x = x, 
           y = y, 
           fill = group)) + 
  ggwaffle::geom_waffle() +
  ggplot2::theme(legend.position = "right") +
  ggwaffle::theme_waffle() + 
  labs(title = "Weightlifting",
    subtitle = "Most common WADA banned substances",
    x = "", y = "")

ggp_cycling_waffle <- ggplot2::ggplot(data = waffle_cycling, 
       ggplot2::aes(x = x, 
           y = y, 
           fill = group)) + 
  ggwaffle::geom_waffle() +
  ggplot2::theme(legend.position = "right") +
  ggwaffle::theme_waffle() + 
  labs(title = "Cycling",
    subtitle = "Most common WADA banned substances",
    x = "", y = "")
```

